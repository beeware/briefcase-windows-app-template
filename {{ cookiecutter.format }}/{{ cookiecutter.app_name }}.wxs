<?define ProductVersion = "{{ cookiecutter.version_triple }}" ?>
<?define ProductUpgradeCode = "{{ cookiecutter.guid }}" ?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
    <Package
        UpgradeCode="$(var.ProductUpgradeCode)"
        Name="{{ cookiecutter.formal_name }}"
        Version="$(var.ProductVersion)"
        Manufacturer="{{ cookiecutter.author or 'Anonymous' }}"
        Language="1033"
        Scope="perUserOrMachine">  <!-- See scope comments below -->

        <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

        <Icon Id="ProductIcon" SourceFile="icon.ico" />

        <!-- Add/Remove Programs settings -->
        <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
        {% if cookiecutter.url -%}
        <Property Id="ARPURLINFOABOUT" Value="{{ cookiecutter.url }}" />
        {% endif -%}
        {% if cookiecutter.author_email -%}
        <Property Id="ARPCONTACT" Value="{{ cookiecutter.author_email }}" />
        {% endif -%}
        <Property Id="ARPNOREPAIR" Value="1" />
        <Property Id="ARPNOMODIFY" Value="1" />

        <Upgrade Id="$(var.ProductUpgradeCode)">
            <UpgradeVersion
                Minimum="$(var.ProductVersion)"
                OnlyDetect="yes"
                Property="NEWERVERSIONDETECTED" />
            <UpgradeVersion
                Minimum="0.0.0"
                Maximum="$(var.ProductVersion)"
                IncludeMinimum="yes"
                IncludeMaximum="no"
                Property="OLDERVERSIONBEINGUPGRADED" />
        </Upgrade>

        <!-- If we ever add the InstallDirDlg, it will use this property to control the
        target directory. The value must be upper case to make it a public property
        that will be passed to the execution phase. -->
        <Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONFOLDER" />

        <!-- This is either the per-user or the per-machine Program Files folder,
        depending on the values of the ALLUSERS and MSIINSTALLPERUSER properties. -->
        <StandardDirectory Id="ProgramFiles64Folder">
            {%- if cookiecutter.use_full_install_path %}
            <Directory Name="{{ cookiecutter.author or 'Unknown Developer' }}">
            {%- endif %}
            <Directory Id="APPLICATIONFOLDER" Name="{{ cookiecutter.formal_name }}" />
            {%- if cookiecutter.use_full_install_path %}
            </Directory>
            {%- endif %}
        </StandardDirectory>

        <ComponentGroup Id="{{ cookiecutter.module_name }}_COMPONENTS">
            <Files
                Directory="APPLICATIONFOLDER"
                Include="{{ cookiecutter.package_path }}\**" />
        </ComponentGroup>

        {% if cookiecutter.console_app %}
        <Component
            Id="SystemPathEnv"
            Guid="{{ '.'.join(['system-path', cookiecutter.app_name] + cookiecutter.bundle.split('.')[::-1])|dns_uuid5 }}">
            <Environment
                Id="AppendSystemPathEnvValue"
                Name="PATH"
                Action="set"
                Part="last"
                System="yes"
                Value="[APPLICATIONFOLDER]"
                Permanent="no" />
        </Component>
        <Component
            Id="UserPathEnv"
            Guid="{{ '.'.join(['user-path', cookiecutter.app_name] + cookiecutter.bundle.split('.')[::-1])|dns_uuid5 }}">
            <Environment
                Id="AppendUserPathEnvValue"
                Name="PATH"
                Action="set"
                Part="last"
                System="no"
                Value="[APPLICATIONFOLDER]"
                Permanent="no" />
        </Component>
        {% endif %}

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ProgramMenuSubfolder" Name="{{ cookiecutter.formal_name }}">
                <Component Id="ApplicationShortcuts">
                    <Shortcut
                        Id="ApplicationShortcut1"
                        Name="{{ cookiecutter.formal_name }}"
                        Icon="ProductIcon"
                        Description="{{ cookiecutter.description }}"
                        Target="[APPLICATIONFOLDER]{{ cookiecutter.binary_path }}" />
                    <RegistryValue
                        Root="HKMU"
                        Key="Software\{{ cookiecutter.author or 'Unknown Developer' }}\{{ cookiecutter.formal_name }}"
                        Name="installed"
                        Type="integer"
                        Value="1"
                        KeyPath="yes" />
                    <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall" />
                </Component>
            </Directory>
        </StandardDirectory>

        {% if cookiecutter.document_types -%}
        <SetProperty
            Id="FileAssociationProperty"
            Value="[APPLICATIONFOLDER]{{ cookiecutter.binary_path }}"
            After="CostFinalize" />

        {% for document_type_id, document_type in cookiecutter.document_types|dictsort -%}
        <Component
            Id="FileAssociation.{{ document_type_id }}"
            Directory="APPLICATIONFOLDER">
            <File
                Id="ProductIcon.{{ document_type_id }}"
                Source="{{ cookiecutter.app_name }}-{{ document_type_id }}.ico" />
            <ProgId
                Id="MyApp.{{ document_type_id }}"
                Description="{{ document_type.description }}"
                Icon="ProductIcon.{{ document_type_id }}">
                <Extension
                    Id="{{ document_type.extension }}"
                    ContentType="{% if document_type.get('mime_type') %}{{ document_type.mime_type }}{% else %}application/x-{{ cookiecutter.app_name }}-{{ document_type_id }}{% endif %}">
                    <Verb
                        Id="open"
                        Command="Open"
                        TargetProperty="FileAssociationProperty"
                        Argument='"%1"' />
                </Extension>
            </ProgId>
        </Component>
        {%- endfor %}
        {%- endif %}

        <InstallExecuteSequence>
            <RemoveExistingProducts After="InstallValidate" />
        </InstallExecuteSequence>

        <Feature Id="DefaultFeature" Level="1">
            <ComponentGroupRef Id="{{ cookiecutter.module_name }}_COMPONENTS" />
            <ComponentRef Id="ApplicationShortcuts" />
            {%- for document_type_id in cookiecutter.document_types.keys()|sort %}
            <ComponentRef Id="FileAssociation.{{ document_type_id }}" />
            {%- endfor %}
        </Feature>

        {% if cookiecutter.console_app %}
        <Feature Id="SystemPathEnvFeature" Level="1">
            <Level Value="0" Condition="ALLUSERS=2 OR MSIINSTALLPERUSER=1" />
            <ComponentRef Id="SystemPathEnv" />
        </Feature>
        <Feature Id="UserPathEnvFeature" Level="1">
            <Level Value="0" Condition="ALLUSERS=1" />
            <ComponentRef Id="UserPathEnv" />
        </Feature>
        {% endif %}

        <!-- UI features are documented at https://docs.firegiant.com/wix3/wixui/, and
        implemented in the WiX source code under src/ext/UI/wixlib.

        We implement our own UI flow by linking together individual dialogs. There are
        some pre-defined UI flows such as WixUI_Advanced, but they don't allow much
        customization, and they have some bugs, e.g.
        https://github.com/wixtoolset/issues/issues/5908. -->

        <!-- Enable the radio buttons in InstallScopeDlg -->
        <WixVariable Id="WixUISupportPerUser" Value="1" />
        <WixVariable Id="WixUISupportPerMachine" Value="1" />

        <UI>
            <!-- Include all TextStyles from WixUI_Advanced -->
            <TextStyle
                Id="WixUI_Font_Normal"
                FaceName="!(loc.Advanced_Font_FaceName)"
                Size="!(loc.Advanced_Font_Normal_Size)" />
            <TextStyle
                Id="WixUI_Font_Bigger"
                FaceName="!(loc.Advanced_Font_FaceName)"
                Size="!(loc.Advanced_Font_Bigger_Size)" />
            <TextStyle
                Id="WixUI_Font_Title"
                FaceName="!(loc.Advanced_Font_FaceName)"
                Size="!(loc.Advanced_Font_Title_Size)"
                Bold="yes" />
            <TextStyle
                Id="WixUI_Font_Emphasized"
                FaceName="!(loc.Advanced_Font_FaceName)"
                Size="!(loc.Advanced_Font_Emphasized_Size)"
                Bold="yes" />
            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />

            <!-- Include all DialogRefs from WixUI_Advanced. These include:

            * Child dialogs launched from top-level dialogs.
            * Dialogs implicitly shown at particular points in the install, determined
              either by their IDs, or the InstallUISequence in their source code. -->
            <DialogRef Id="BrowseDlg" />
            <DialogRef Id="DiskCostDlg" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />
            <DialogRef Id="WelcomeDlg" />

            <!-- For consistency, we always set the <Package> Scope to
            "perUserOrMachine", which initializes ALLUSERS=2 and MSIINSTALLPERUSER=1
            (https://learn.microsoft.com/en-us/windows/win32/msi/single-package-authoring).
            This may also avoid some bugs with the other Scope values
            (e.g. https://github.com/wixtoolset/issues/issues/8101).

            When ALLUSERS is 2 at the start of a phase, the system changes it to 1 or ""
            depending on the value of MSIINSTALLPERUSER. For this to work in the
            execution phase, the UI phase must reset ALLUSERS to 2, and set
            MSIINSTALLPERUSER to the desired scope. This immediately triggers a
            re-evaluation of APPLICATIONFOLDER, which will affect the InstallDirDlg if
            we ever add it.

            Alternative approaches which only set ALLUSERS, as WixUI_Advanced does,
            will unnecessarily make a UAC elevation request even for per-user installs
            (https://github.com/wixtoolset/issues/issues/5481). -->
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Order="1"
                Property="ALLUSERS"
                Value="2" />

            {% if cookiecutter.install_scope == "perUserOrMachine" %}
            <!-- Let the user choose the scope. -->
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Order="2"
                Event="NewDialog"
                Value="InstallScopeDlg" />

            <Publish
                Dialog="InstallScopeDlg"
                Control="Back"
                Event="NewDialog"
                Value="WelcomeDlg" />

            <Property Id="WixAppFolder" Value="WixPerUserFolder" />
            <Publish
                Dialog="InstallScopeDlg"
                Control="Next"
                Order="1"
                Condition='WixAppFolder = "WixPerUserFolder"'
                Property="MSIINSTALLPERUSER"
                Value="1" />
            <Publish
                Dialog="InstallScopeDlg"
                Control="Next"
                Order="2"
                Condition='WixAppFolder = "WixPerMachineFolder"'
                Property="MSIINSTALLPERUSER"
                Value="{}" />
            <Publish
                Dialog="InstallScopeDlg"
                Control="Next"
                Order="3"
                Event="EndDialog"
                Value="Return" />

            {% else %}
            <!-- The scope is pre-determined. -->
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Order="2"
                Property="MSIINSTALLPERUSER"
                Value="{{ 1 if cookiecutter.install_scope == 'perUser' else '{}' }}" />
            <Publish
                Dialog="WelcomeDlg"
                Control="Next"
                Order="3"
                Event="EndDialog"
                Value="Return" />
            {% endif %}

            <Publish
                Dialog="ExitDialog"
                Control="Finish"
                Event="EndDialog"
                Value="Return"
                Order="999" />
        </UI>

        <!-- Include necessary strings (https://stackoverflow.com/questions/44161526) -->
        <UIRef Id="WixUI_ErrorProgressText" />
        <UIRef Id="WixUI_Common" />
    </Package>
</Wix>
