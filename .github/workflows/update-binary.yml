name: Update binary
on:
  push:
    tags:
    - '*-b*'

jobs:
  build-templates:
    runs-on: windows-latest
    steps:
    - name: Set build variables
      env:
        TAG_NAME: ${{ github.ref }}
      run: |
        $env:TAG=$env:TAG_NAME.split("/")[-1]
        echo TAG=$env:TAG
        $env:TAG_VERSION=$env:TAG.split("-")[0]
        $env:TAG_BUILD=$env:TAG.split("-")[1]
        echo PY_VERSION=$env:TAG_VERSION
        echo BUILD_NUMBER=$env:TAG_BUILD
        "TAG=$env:TAG" >> $env:GITHUB_ENV
        "PY_VERSION=$env:TAG_VERSION" >> $env:GITHUB_ENV
        "BUILD_NUMBER=$env:TAG_BUILD" >> $env:GITHUB_ENV
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ env.PY_VERSION }}
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install briefcase
    - name: Generate VisualStudio stub app
      run: |
        # Generate the stub app
        cd stub
        briefcase create windows visualstudio
        briefcase build windows visualstudio
        echo "Move the binary into the final location"
        cd ..
        Copy-Item .\stub\windows\visualstudio\Stub\x64\Release\Stub.exe -Destination ".\{{ cookiecutter.formal_name }}\src\{{ cookiecutter.formal_name }}.exe"
        echo "Commit new binary"
        git config user.email "brutus@beeware.org"
        git config user.name "Brutus (robot)"
        git add ".\{{ cookiecutter.formal_name }}\src\{{ cookiecutter.formal_name }}.exe"
        git commit -m "AUTO: Update app binary for Python ${{ env.PY_VERSION }} build ${{ env.BUILD_NUMBER }}"
        echo "Push new binary to repository"
        git push origin HEAD:${{ env.PY_VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
